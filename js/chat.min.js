(function(){var __updateCounter,fgFromBg,hexToRgb,placeholderMessage,showMessages,update;$(document).ready(function(){var adjustContainerSize,chatContainer,clearTimers,countDown,inputContainer,lockBtn,lockInterval,lockOverlay,lockScreen,lockTimer,logoutBtn,overlay,sendBtn,sendOnEnter,sendOnEnterCheckbox,timeout,unlockBtn,unlockInput,unlockScreen,updateAllBtn,updateTimeInLock;return overlay=$(".overlay"),lockOverlay=$(".lockOverlay"),countDown=$(".countDown"),unlockInput=lockOverlay.find("input.unlock"),unlockBtn=lockOverlay.find("button.unlock"),chatContainer=$(".chatContainer"),inputContainer=$(".inputContainer"),sendOnEnterCheckbox=$("#sendOnEnter"),lockBtn=$(".lock"),sendBtn=$(".btn.send"),updateAllBtn=$(".btn.updateAll"),logoutBtn=$(".btn.logout"),timeout=60,lockTimer=null,lockInterval=null,sendOnEnter=!0,clearTimers=function(){return null!=lockTimer&&clearTimeout(lockTimer),null!=lockInterval&&clearInterval(lockInterval),countDown.text(""),!0},lockScreen=function(){return clearTimers(),lockOverlay.fadeIn(40),unlockInput.focus(),!0},updateTimeInLock=function(evt){var msecs;return null==evt&&(evt={}),clearTimers(),msecs=1e3*timeout,lockTimer=setTimeout(lockScreen,msecs),lockInterval=setInterval(function(){return msecs>0?(countDown.text(msecs/1e3),msecs-=1e3):(countDown.text(""),clearInterval(lockInterval)),!0},1e3),13===evt.which&&sendOnEnter?(sendBtn.click(),!1):!0},unlockScreen=function(){return $.post("php/api.php?r=unlock",{pw:unlockInput.val()},function(resp){return"true"===resp?(lockOverlay.fadeOut(100),unlockInput.removeClass("error").val(""),updateTimeInLock()):unlockInput.addClass("error"),!0}),!0},inputContainer.find("#message").keyup(function(evt){return updateTimeInLock(evt)}),sendOnEnterCheckbox.change(function(){return sendOnEnter=!sendOnEnter,!0}),lockBtn.click(function(){return lockScreen(),!0}),unlockInput.keyup(function(evt){return 13===evt.which?(unlockScreen(),!1):!0}),unlockBtn.click(function(){return unlockScreen(resp)}),sendBtn.click(function(){var content,textarea;return textarea=$("#message"),content=textarea.val(),0===content.length?(textarea[0].focus(),!0):($.post("php/api.php?r=save",{n:$("#name").val(),m:content},function(){return $(".message").val(""),clearTimeout(nextTimeout),update(),this}),textarea[0].focus(),!0)}),updateAllBtn.click(function(){return overlay.fadeIn(100,function(){return $.post("php/api.php?r=update_all",function(){return clearTimeout(nextTimeout),chatContainer.empty(),window.latestTimestamp=null,update("update_all"),overlay.delay(600).fadeOut(100),updateTimeInLock(),this}),!0}),!0}),logoutBtn.click(function(){return $.post("php/api.php?r=logout",function(){return clearTimeout(nextTimeout),open("index.php","_self"),this}),!0}),window.latestTimestamp=null,updateTimeInLock(),update(),adjustContainerSize=function(){return chatContainer.css("height",window.innerHeight-inputContainer.outerHeight()-60),!0},$(window).resize(function(){return adjustContainerSize()}),adjustContainerSize(),!0}),hexToRgb=function(hex){var result,shorthandRegex;return shorthandRegex=/^#?([a-f\d])([a-f\d])([a-f\d])$/i,hex=hex.replace(shorthandRegex,function(m,r,g,b){return r+r+g+g+b+b}),result=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex),{r:parseInt(result[1],16),g:parseInt(result[2],16),b:parseInt(result[3],16)}},fgFromBg=function(hex){var lightness,rgb;return rgb=hexToRgb(hex),lightness=Math.round((299*rgb.r+587*rgb.g+114*rgb.b)/1e3),lightness>125?"black":"white"},showMessages=function(messages){var alignment,bg,container,date,i,idx,j,len,len1,message,newMessage,textColor,updated,word,words;for(container=$(".chatContainer"),updated=$('<div class="row updated" />'),i=0,len=messages.length;len>i;i++){for(message=messages[i],alignment=message.name===$("#name").val()?"right":"left",date=moment(message.timestamp,"X"),bg=date.isBefore(new Date,"day")?"#cccccc":"#"+string_to_color(message.name),textColor=fgFromBg(bg),words=message.message.split(" "),newMessage=[],idx=j=0,len1=words.length;len1>j;idx=++j)word=words[idx],"https"===word.slice(0,5)?newMessage.push("<a style='color: "+textColor+";' href='"+word+"' target='_blank'>"+word.slice(8)+"</a>"):"http"===word.slice(0,4)?newMessage.push("<a style='color: "+textColor+";' href='"+word+"' target='_blank'>"+word.slice(7)+"</a>"):newMessage.push(word);newMessage=newMessage.join(" "),updated.append('<div class="col-xs-9 col-md-8 col-lg-7 message '+("left"===alignment?"":"col-xs-push-3 col-md-push-4 col-lg-push-5")+'" style="background-color: '+bg+"; color: "+textColor+';">\n    <div class="name">'+message.name+'</div>\n    <div class="time">'+date.format("HH:mm")+'</div>\n    <div class="content">'+newMessage+'</div>\n</div>\n<div class="clear" />')}return container.append(updated),updated.find(".content").emoticonize(),updated.slideDown(500,function(){var div;return div=container[0],div.scrollTop=div.scrollHeight,!0}),this},__updateCounter=-1,placeholderMessage=!0,update=function(action){return null==action&&(action="update"),$.post("php/api.php?r="+action,{ts:latestTimestamp},function(response){var place;return response=JSON.parse(response),0===response.length?"undefined"==typeof latestTimestamp||null===latestTimestamp?(showMessages([{name:"System",message:"...heute noch keine Nachrichten...",timestamp:-1}]),window.latestTimestamp=-1,!0):!1:(placeholderMessage&&($(".name:contains('System')").parent().remove(),place=!1),response=response.sort(function(a,b){return a.timestamp-b.timestamp}),window.latestTimestamp=response[response.length-1].timestamp,showMessages(response),!0)}),++__updateCounter%3===0&&$.post("php/api.php?r=users",function(response){var bg,i,len,user,users,usersDiv;for(users=JSON.parse(response),usersDiv=$(".inputContainer .users"),usersDiv.empty().html("Angemeldete Nutzer: "),i=0,len=users.length;len>i;i++)user=users[i],bg="#"+string_to_color(user),usersDiv.append("<span class='label' style='background-color: "+bg+"; color: "+fgFromBg(bg)+";'>"+user+"</span>");return!0}),window.nextTimeout=setTimeout(update,1e4),this}}).call(this);