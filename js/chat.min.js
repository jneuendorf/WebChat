(function(){var fgFromBg,hexToRgb,placeholderMessage,showMessages,update,__updateCounter;$(document).ready(function(){var chatContainer,inputContainer,logoutBtn,overlay,sendBtn,updateAllBtn;return overlay=$(".overlay"),chatContainer=$(".chatContainer"),inputContainer=$(".inputContainer"),sendBtn=$(".btn.send"),sendBtn.click(function(){var content,textarea;return textarea=$("#message"),content=textarea.val(),0===content.length?(textarea[0].focus(),!0):($.post("php/api.php?r=save",{n:$("#name").val(),m:content},function(){return $(".message").val(""),clearTimeout(nextTimeout),update(),this}),textarea[0].focus(),!0)}),updateAllBtn=$(".btn.updateAll"),updateAllBtn.click(function(){return overlay.fadeIn(100),$.post("php/api.php?r=update_all",function(){return clearTimeout(nextTimeout),chatContainer.empty(),window.latestTimestamp=null,update("update_all"),overlay.delay(600).fadeOut(100),this}),!0}),logoutBtn=$(".btn.logout"),logoutBtn.click(function(){return $.post("php/api.php?r=logout",function(){return clearTimeout(nextTimeout),open("index.php","_self"),this}),!0}),chatContainer.css("height",window.innerHeight-inputContainer.outerHeight()-40),window.latestTimestamp=null,update(),$(window).resize(function(){return chatContainer.css("height",window.innerHeight-inputContainer.outerHeight()-40),!0}),!0}),hexToRgb=function(hex){var result,shorthandRegex;return shorthandRegex=/^#?([a-f\d])([a-f\d])([a-f\d])$/i,hex=hex.replace(shorthandRegex,function(m,r,g,b){return r+r+g+g+b+b}),result=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex),{r:parseInt(result[1],16),g:parseInt(result[2],16),b:parseInt(result[3],16)}},fgFromBg=function(hex){var lightness,rgb;return rgb=hexToRgb(hex),lightness=Math.round((299*rgb.r+587*rgb.g+114*rgb.b)/1e3),lightness>125?"black":"white"},showMessages=function(messages){var alignment,bg,container,date,idx,message,newMessage,textColor,updated,word,words,_i,_j,_len,_len1;for(container=$(".chatContainer"),updated=$('<div class="updated" />'),_i=0,_len=messages.length;_len>_i;_i++){for(message=messages[_i],alignment=message.name===$("#name").val()?"right":"left",date=moment(message.timestamp,"X"),bg=date.isBefore(new Date,"day")?"#cccccc":"#"+string_to_color(message.name),textColor=fgFromBg(bg),words=message.message.split(" "),newMessage=[],idx=_j=0,_len1=words.length;_len1>_j;idx=++_j)word=words[idx],newMessage.push("https"===word.slice(0,5)?"<a style='color: "+textColor+";' href='"+word+"' target='_blank'>"+word.slice(8)+"</a>":"http"===word.slice(0,4)?"<a style='color: "+textColor+";' href='"+word+"' target='_blank'>"+word.slice(7)+"</a>":word);newMessage=newMessage.join(" "),updated.append('<div class="message '+alignment+'" style="background-color: '+bg+"; color: "+textColor+';">\n    <div class="name">'+message.name+'</div>\n    <div class="time">'+date.format("HH:mm")+'</div>\n    <div class="content">'+newMessage+'</div>\n</div>\n<div class="clear" />')}return container.append(updated),updated.find(".content").emoticonize(),updated.slideDown(500,function(){var div;return div=container[0],div.scrollTop=div.scrollHeight,!0}),this},__updateCounter=-1,placeholderMessage=!0,update=function(action){return null==action&&(action="update"),$.post("php/api.php?r="+action,{ts:latestTimestamp},function(response){var place;return response=JSON.parse(response),0===response.length?"undefined"==typeof latestTimestamp||null===latestTimestamp?(showMessages([{name:"System",message:"...heute noch keine Nachrichten...",timestamp:-1}]),$(".name:contains('System')").parent().css("margin-left",200),window.latestTimestamp=-1,!0):!1:(placeholderMessage&&($(".name:contains('System')").parent().remove(),place=!1),response=response.sort(function(a,b){return a.timestamp<b.timestamp?-1:a.timestamp>b.timestamp?1:0}),window.latestTimestamp=response[response.length-1].timestamp,showMessages(response),!0)}),++__updateCounter%3===0&&$.post("php/api.php?r=users",function(response){var bg,user,users,usersDiv,_i,_len;for(users=JSON.parse(response),usersDiv=$(".inputContainer .users"),usersDiv.empty().html("Angemeldete Nutzer: "),_i=0,_len=users.length;_len>_i;_i++)user=users[_i],bg="#"+string_to_color(user),usersDiv.append("<span style='background-color: "+bg+"; color: "+fgFromBg(bg)+";'>"+user+"</span>");return!0}),window.nextTimeout=setTimeout(update,1e4),this}}).call(this);